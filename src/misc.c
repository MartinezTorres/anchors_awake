#include <common.h>



void update_ship_tile(uint8_t i, uint8_t j) {

	yield();
	
	if (map_revealed[i][j]>EMPTY) return;
	
	if (map_display[i][j]<=WATER) return;
	
	uint8_t c = 0;
	if (map_display[i-1][j]==WATER) c += 0x1;
	if (map_display[i+1][j]==WATER) c += 0x2;
	if (map_display[i][j-1]==WATER) c += 0x4;
	if (map_display[i][j+1]==WATER) c += 0x8;

	static const uint8_t TYPES[] = {
		// 0000
		// ...
		// ...
		// ...
		SHIP_UNDEFINED, 
		// 0001
		// .#.
		// ...
		// ...
		SHIP_UNDEFINED, 
		// 0010
		// ...
		// ...
		// .#.
		SHIP_UNDEFINED, 
		// 0011
		// .#.
		// ...
		// .#.
		SHIP_CENTER_HORIZONTAL, 
		// 0100
		// ...
		// #..
		// ...
		SHIP_UNDEFINED, 
		// 0101
		// .#.
		// #..
		// ...
		SHIP_UNDEFINED, 
		// 0110
		// ...
		// #..
		// .#.
		SHIP_UNDEFINED, 
		// 0111
		// .#.
		// #..
		// .#.
		SHIP_LEFT, 
		// 1000
		// ...
		// ..#
		// ...
		SHIP_UNDEFINED, 
		// 1001
		// .#.
		// ..#
		// ...
		SHIP_UNDEFINED, 
		// 1010
		// ...
		// ..#
		// .#.
		SHIP_UNDEFINED, 
		// 1011
		// .#.
		// ..#
		// .#.
		SHIP_RIGHT, 
		// 1100
		// ...
		// #.#
		// ...
		SHIP_CENTER_VERTICAL, 
		// 1101
		// .#.
		// #.#
		// ...
		SHIP_TOP, 
		// 1110
		// ...
		// #.#
		// .#.
		SHIP_BOTTOM, 
		// 1111
		// .#.
		// #.#
		// .#.
		SHIP_SUB
	};
	if (map_display[i][j] != TYPES[c]) {
		map_display[i][j] = TYPES[c];
		drawCell_int(j-1,i-1,map_display[i][j], map_correctness[i][j]);

		update_ship_tile(i+1,j);
		update_ship_tile(i-1,j);
		update_ship_tile(i,j+1);
		update_ship_tile(i,j-1);
	}
}


void update_correctness() {
	
	for (uint8_t i=1; i<11; i++) {
		yield();
		for (uint8_t j=1; j<11; j++) {
			yield();
			bool correct = 1;
			if (map_display[i][j]<=WATER) continue;
			
			if (map_display[i-1][j+1]>WATER) correct = false;
			if (map_display[i+1][j+1]>WATER) correct = false;
			if (map_display[i-1][j-1]>WATER) correct = false;
			if (map_display[i+1][j-1]>WATER) correct = false;

			if (map_display[i-1][j]>WATER && map_display[i][j+1]>WATER) correct = false;
			if (map_display[i+1][j]>WATER && map_display[i][j+1]>WATER) correct = false;
			if (map_display[i-1][j]>WATER && map_display[i][j-1]>WATER) correct = false;
			if (map_display[i+1][j]>WATER && map_display[i][j-1]>WATER) correct = false;
			
			if (map_correctness[i][j] != correct) {
				map_correctness[i][j] = correct;
				drawCell_int(j-1,i-1,map_display[i][j], map_correctness[i][j]);
			}
		}
	}
}


void drawCell_int(uint8_t x, uint8_t y, uint8_t type, uint8_t color_scheme) {

	yield();
	
static const uint8_t IMG_TILES[][32] = {
	{ // EMPTY
		0xFF, 0xFF, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 
		0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 
		0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 
		0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0xFF, 0xFF},
	{ // WATER
		0xFF, 0xFF, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 
		0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 
		0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 
		0x80, 0x01, 0x80, 0x01, 0x80, 0x01, 0xFF, 0xFF},
	{ // SHIP_UNDEFINED
		0b00000000, 0b00000000,
		0b00000000, 0b00000000,
		0b00111111, 0b11111100,
		0b00111111, 0b11111100,

		0b00111111, 0b11111100,
		0b00111111, 0b11111100,
		0b00111111, 0b11111100,
		0b00111111, 0b11111100,

		0b00111111, 0b11111100,
		0b00111111, 0b11111100,
		0b00111111, 0b11111100,
		0b00111111, 0b11111100,

		0b00111111, 0b11111100,
		0b00111111, 0b11111100,
		0b00000000, 0b00000000,
		0b00000000, 0b00000000},
	{  //SHIP_SUB
		0b11110000, 0b00001111,
		0b11000111, 0b11100011,
		0b10011111, 0b11111001,
		0b10111111, 0b11111101,

		0b00111111, 0b11111100,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,

		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b00111111, 0b11111100,

		0b10111111, 0b11111101,
		0b10011111, 0b11111001,
		0b11000111, 0b11100011,
		0b11110000, 0b00001111}, 
	{ // SHIP_TOP
		0b11110000, 0b00001111,
		0b11000111, 0b11100011,
		0b10011111, 0b11111001,
		0b10111111, 0b11111101,

		0b10111111, 0b11111101,
		0b10111111, 0b11111101,
		0b00111111, 0b11111100,
		0b01111111, 0b11111110,

		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,

		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110}, 
	{ // SHIP_CENTER_VERTICAL

		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,

		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110, 

		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,

		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110}, 
	{ // SHIP_BOTTOM
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,

		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,

		0b01111111, 0b11111110,
		0b00111111, 0b11111100,
		0b10111111, 0b11111101,
		0b10111111, 0b11111101,

		0b10111111, 0b11111101,
		0b10011111, 0b11111001,
		0b11000111, 0b11100011,
		0b11110000, 0b00001111,
		}, 
	{ // SHIP_LEFT
		0b11111100, 0b00000000,
		0b11000001, 0b11111111,
		0b10011111, 0b11111111,
		0b10111111, 0b11111111,

		0b00111111, 0b11111111,
		0b01111111, 0b11111111,
		0b01111111, 0b11111111,
		0b01111111, 0b11111111,

		0b01111111, 0b11111111,
		0b01111111, 0b11111111,
		0b01111111, 0b11111111,
		0b00111111, 0b11111111,

		0b10111111, 0b11111111,
		0b10011111, 0b11111111,
		0b11000001, 0b11111111,
		0b11111100, 0b00000000,}, 
	{ // SHIP_CENTER_HORIZONTAL
		0b00000000, 0b00000000,
		0b11111111, 0b11111111,
		0b11111111, 0b11111111,
		0b11111111, 0b11111111,

		0b11111111, 0b11111111,
		0b11111111, 0b11111111,
		0b11111111, 0b11111111,
		0b11111111, 0b11111111,

		0b11111111, 0b11111111,
		0b11111111, 0b11111111,
		0b11111111, 0b11111111,
		0b11111111, 0b11111111,

		0b11111111, 0b11111111,
		0b11111111, 0b11111111,
		0b11111111, 0b11111111,
		0b00000000, 0b00000000,}, 
	{ // SHIP_RIGHT
		0b00000000, 0b00111111,
		0b11111111, 0b10000011,
		0b11111111, 0b11111001,
		0b11111111, 0b11111101,

		0b11111111, 0b11111100,
		0b11111111, 0b11111110,
		0b11111111, 0b11111110,
		0b11111111, 0b11111110,

		0b11111111, 0b11111110,
		0b11111111, 0b11111110,
		0b11111111, 0b11111110,
		0b11111111, 0b11111100,

		0b11111111, 0b11111101,
		0b11111111, 0b11111001,
		0b11111111, 0b11000011,
		0b00000000, 0b00111111},
	{  //SHIP_SUB_LEGEND
		0b00000000, 0b00000000,
		0b00000111, 0b11100000,
		0b00011111, 0b11111000,
		0b00111111, 0b11111100,

		0b00111111, 0b11111100,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,

		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b00111111, 0b11111100,

		0b00111111, 0b11111100,
		0b00011111, 0b11111000,
		0b00000111, 0b11100000,
		0b00000000, 0b00000000}, 
	{ // SHIP_LEFT_LEGEND
		0b00000000, 0b00000000,
		0b00000001, 0b11111110,
		0b00011111, 0b11111110,
		0b00111111, 0b11111110,

		0b00111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,

		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b00111111, 0b11111110,

		0b00111111, 0b11111110,
		0b00011111, 0b11111110,
		0b00000001, 0b11111110,
		0b00000000, 0b00000000,}, 
	{ // SHIP_CENTER_HORIZONTAL_LEGEND
		0b00000000, 0b00000000,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,

		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,

		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,

		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b00000000, 0b00000000,}, 
	{ // SHIP_RIGHT_LEGEND
		0b00000000, 0b00000000,
		0b01111111, 0b10000000,
		0b01111111, 0b11111000,
		0b01111111, 0b11111100,

		0b01111111, 0b11111100,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,

		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111110,
		0b01111111, 0b11111100,

		0b01111111, 0b11111100,
		0b01111111, 0b11111000,
		0b01111111, 0b11000000,
		0b00000000, 0b00000000},
    { // SHIP_EXPLOSION
		0b00000000, 0b00000000,
		0b01100010, 0b01111000,
		0b01100000, 0b11111100,
		0b00001100, 0b11111100,

		0b00001100, 0b11111100,
		0b00100000, 0b11111100,
		0b01110000, 0b01111000,
		0b00100010, 0b00000000,

		0b00000000, 0b01110000,
		0b00111100, 0b11111000,
		0b01111110, 0b11111000,
		0b01111110, 0b01110000,

		0b01111110, 0b00000000,
		0b01111110, 0b01000100,
		0b00111100, 0b00001110,
		0b00000000, 0b00000100},
	};
	
	uint8_t color = FGray+BBlack;
	if (color_scheme==1) { // correct
		if (type==WATER) color = FGray+BLightBlue;
		if (type >WATER) color = FGray+BDarkBlue;
	}
	
	if (color_scheme==0) { // incorrect
		if (type==WATER) color = FGray+BLightBlue;
		if (type >WATER) color = FLightRed+BDarkRed;
	}

	if (color_scheme==2) { // solving
		if (type==WATER) color = FWhite+BLightBlue;
		if (type >WATER) color = FWhite+BDarkBlue;
	}

	if (color_scheme==3) { // exploding
		if (type==WATER) color = FWhite+BLightBlue;
		if (type >WATER) {
            color = FLightYellow+BDarkRed;
            type = SHIP_EXPLOSION;
        }
	}
	
	const uint8_t *data = &IMG_TILES[type][0];
	for (uint8_t i=0; i<16; i++) {
		setPoints_v8c(16*x  ,16*y+i,data[2*i+0], color);
		setPoints_v8c(16*x+8,16*y+i,data[2*i+1], color);
	}
}

